<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>Draw Me Nearer</title>
    <script src="https://cdn.jsdelivr.net/npm/@coderline/alphatab@latest/dist/alphaTab.js"></script>
    <script src="https://kit.fontawesome.com/276b45691a.js" crossorigin="anonymous"></script>
    <style type="text/css">
      .at-wrap {
        width: 98vw;
        height: 98vh;
        margin: 0 auto;
        border: 1px solid rgba(0,0,0, 0.12);
        display: flex;
        flex-direction: column;
        overflow: hidden;
        position: relative;
      }
      .at-content {
        position: relative;
        overflow: hidden;
        flex: 1 1 auto;
      }
      /** Sidebar **/
      .at-sidebar {
        position: absolute;
        top: 0;
        left: 0;
        bottom: 0;
        max-width: 70px;
        width: auto;
        display: flex;
        align-content: stretch;
        z-index: 1001;
        overflow: hidden;
        border-right: 1px solid rgba(0,0,0, 0.12);
        background: #f7f7f7;
      }
      .at-sidebar:hover {
        max-width: 400px;
        transition: max-width 0.2s;
        overflow-y: auto;
      }

      /** Track selector **/
      .at-track {
        display: flex;
        position: relative;
        padding: 5px;
        transition: background 0.2s;
        cursor: pointer;
      }
      .at-track:hover {
        background: rgba(0,0,0,0.1);
      }
      .at-track > .at-track-icon,
      .at-track > .at-track-details {
        display: flex;
        flex-direction: column;
        justify-content: center;
      }
      .at-track > .at-track-icon {
        flex-shrink: 0;
        font-size: 32px;
        opacity: 0.5;
        transition: opacity 0.2s;
        width: 64px;
        height: 64px;
        margin-right: 5px;
        align-items: center;
      }
      .at-track-name {
        font-weight: bold;
        margin-bottom: 5px;
      }
      .at-track:hover > .at-track-icon {
        opacity: 0.8;
      }
      .at-track.active {
        background: rgba(0, 0, 0, 0.03);
      }
      .at-track.active > .at-track-icon {
        color: #4972a1;
        opacity: 1;
      }
      .at-track > .at-track-name {
        font-weight: 500;
      }

      .at-viewport {
        overflow-y: auto;
        position: absolute;
        top: 0;
        left: 70px;
        right: 0;
        bottom: 0;
        padding-right: 20px;
      }
      .at-footer {
        flex: 0 0 auto;
        background: #436d9d;
        color: #fff;
      }
      /** Footer **/
      .at-controls {
        flex: 0 0 auto;
        display: flex;
        justify-content: space-between;
        background: #436d9d;
        color: #fff;
      }
      .at-controls>div {
        display: flex;
        justify-content: flex-start;
        align-content: center;
        align-items: center;
      }
      .at-controls>div>* {
        display: flex;
        text-align: center;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        padding: 4px;
        margin: 0 3px;
      }
      .at-controls .btn {
        color: #fff;
        border-radius: 0;
        height: 40px;
        width: 40px;
        height: 40px;
        font-size: 16px;
      }
      .at-controls a.active {
        background: #5588c7;
        text-decoration: none;
      }
      .at-controls .btn i {
        vertical-align: top;
      }
      .at-controls select {
        -moz-appearance: none;
        -webkit-appearance: none;
        appearance: none;
        border: none;
        width: 100%;
        height: 40px;
        background: #436d9d;
        padding: 4px 10px;
        color: #fff;
        font-size: 16px;
        text-align-last: center;
        text-align: center;
        -ms-text-align-last: center;
        -moz-text-align-last: center;
        cursor: pointer;
      }

      .at-song-title {
        font-weight: bold;
      }
      .at-overlay {
        /** Fill Parent */
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        z-index: 1002;

        /* Blurry dark shade */
        backdrop-filter: blur(3px);
        background: rgba(0, 0, 0, 0.5);

        /** center content */
        display: flex;
        justify-content: center;
        align-items: flex-start;
      }
      .at-overlay-content {
        /* white box with drop-shadow */
        margin-top: 20px;
        background: #fff;
        box-shadow: 0px 5px 10px 0px rgba(0, 0, 0, 0.3);
        padding: 10px;
      }
      .at-cursor-bar {
        /* Defines the color of the bar background when a bar is played */
        background: rgba(255, 242, 0, 0.25);
      }

      .at-selection div {
        /* Defines the color of the selection background */
        background: rgba(64, 64, 255, 0.1);
      }

      .at-cursor-beat {
        /* Defines the beat cursor */
        background: rgba(64, 64, 255, 0.75);
        width: 3px;
      }
      .at-popup {
        position: absolute;
        background: rgba(50, 50, 50, 0.9);
          color: #fff;
        padding: 4px 8px;
        border-radius: 6px;
        font-size: 13px;
        z-index: 2000;
        opacity: 1;
        transition: opacity 0.3s ease;
        pointer-events: none;
      }
      .at-tooltip {
        position: absolute;
        background: rgba(0,0,0,0.85);
        color: #fff;
        padding: 4px 8px;
        border-radius: 4px;
        font-size: 12px;
        pointer-events: none;
        opacity: 0;
        transition: opacity 0.2s ease;
        z-index: 2000;
        white-space: nowrap;
      }
      .at-highlight * {
        /* Defines the color of the music symbols when they are being played (svg) */
        fill: #0078ff;
        stroke: #0078ff;
      }
      .at-controls .btn.disabled {
        cursor: progress;
        opacity: 0.5;
      }
    </style>
  </head>
  <body>
    <iframe id="pdf-preload" src="" style="display:none;"></iframe>
    <div class="at-wrap">
      <div class="at-overlay">
        <div class="at-overlay-content">
          Sheet music is loading
        </div>
      </div>

      <div class="at-content">
        <div class="at-sidebar">
          <div class="at-sidebar-content">
            <div class="at-track-list"></div>
          </div>
        </div>

        <div class="at-viewport">
          <div class="at-main"></div>
        </div>
      </div>

      <div class="at-controls">
        <div class="at-controls-left">
          <!--rewind-->
          <a class="btn at-player-stop disabled">
            <i class="fas fa-step-backward"> </i>
          </a>
          <!--play/pause-->
          <a class="btn at-player-play-pause disabled">
            <i class="fas fa-play"></i>
          </a>
          <!--loading progress-->
          <span class="at-player-progress">0%</span>
          <div class="at-song-info">
            <span class="at-song-title"></span>
          </div>
          <!--file time info-->
          <div class="at-song-position">00:00 / 00:00</div>
        </div>
        <div class="at-controls-right">
          <a class="btn toggle at-count-in">
            <i class="fas fa-hourglass-half"></i>
          </a>
          <a class="btn toggle at-metronome">
            <i class="fas fa-edit"></i>
          </a>
          <a class="btn toggle at-loop">
            <i class="fas fa-retweet"></i>
          </a>
          <a class="btn at-print">
            <i class="fas fa-print"></i>
          </a>
          <div class="at-zoom">
            <i class="fas fa-search"></i>
          <select>
              <option value="25">25%</option>
              <option value="50">50%</option>
              <option value="75">75%</option>
              <option value="90">90%</option>
              <option value="100" selected>100%</option>
              <option value="110">110%</option>
              <option value="125">125%</option>
              <option value="150">150%</option>
              <option value="200">200%</option>
          </select>
          </div>
          <div class="at-layout">
              <select>
                <option value="horizontal">Horizontal</option>
                <option value="page" selected>Page</option>
              </select>
          </div>
        </div>
      </div>

    </div>

    <template id="at-track-template">
      <div class="at-track">
        <div class="at-track-icon">
          <i class="fas fa-music"></i>
        </div>

        <div class="at-track-details">
          <div class="at-track-name"></div>
        </div>
      </div>
    </template>

    <script type="text/javascript">
      // load elements
      const wrapper = document.querySelector(".at-wrap");
      const main = wrapper.querySelector(".at-main");

      // get ?file=... from URL
      const params = new URLSearchParams(window.location.search);
      const fileParam = params.get("file") || "A Beautiful Life"; //fallback
      const fileURL = `https://alanwmueller.github.io/hymns/mxlFiles/${fileParam}.mxl`;
      const printURL = `https://alanwmueller.github.io/hymns/pdfFiles/${fileParam}.pdf`;
      const pdfIframe = document.getElementById("pdf-preload");
      pdfIframe.src = printURL
      //update page title (not used in Odoo embedd)
      document.title = fileParam.replace('.mxl', '');
      // initialize alphatab
      const settings = {
        file: fileURL,
        display: {
          resources: {
            mainGlyphColor: "#000000",
            secondaryGlyphColor: "#000000"
          }
        },
        player: {
          enablePlayer: true,
          soundFont: "https://cdn.jsdelivr.net/npm/@coderline/alphatab@latest/dist/soundfont/sonivox.sf2",
          scrollElement: wrapper.querySelector('.at-viewport')
        },
      };
      const api = new alphaTab.AlphaTabApi(main, settings);

      //overlay logic
      const overlay = wrapper.querySelector(".at-overlay");
      api.renderStarted.on(() =>{
        overlay.style.display = 'flex';
      });
      api.renderFinished.on(() => {
        overlay.style.display = 'none'
      });

      // track selector
      let activeTracks = [];

      function createTrackItem(track, score) {
        const trackItem = document
          .querySelector("#at-track-template")
          .content.cloneNode(true).firstElementChild;

        trackItem.querySelector(".at-track-name").innerText = track.name;
        track.active = true; // every track starts active
        trackItem.track = track;

        trackItem.classList.add("active"); // initially show as active

        trackItem.onclick = (e) => {
          e.stopPropagation();
          // Prevent deactivating the last visible track
          const visibleCount = score.tracks.filter(t => t.active).length;
          if (track.active && visibleCount === 1) {
            showMessage("At least one staff must remain visible.", trackItem);
            return;
          }
          // Toggle active state
          track.active = !track.active;
          trackItem.classList.toggle("active", track.active);
          api.changeTrackMute([track],!track.active)

          // Render tracks in order by index
          const orderedActiveTracks = score.tracks.filter(t => t.active);

          api.renderTracks(orderedActiveTracks);
        };
        return trackItem;
      }

      function updateTrackVolumes(score) {
        score.tracks.forEach(track => {
          track.playbackInfo.channels.forEach(ch => {
            api.player.setChannelVolume(ch.index, track.active ? 1 : 0);
          });
        });
      }

      function showMessage(message, target) {
        const popup = document.createElement("div");
        popup.className = "at-popup";
        popup.innerText = message;

        // position near clicked track
        const rect = target.getBoundingClientRect();
        popup.style.top = rect.bottom + window.scrollY + 8 + "px";
        popup.style.left = rect.left + "px";

        document.body.appendChild(popup);

        // fade out and remove after 1.5s
        setTimeout(() => { popup.style.opacity = "0"; }, 1000);
        setTimeout(() => { popup.remove(); }, 1500);
      }

      // create a single tooltip element
      const tooltip = document.createElement("div");
      tooltip.className = "at-tooltip";
      document.body.appendChild(tooltip);

      let tooltipTimer;
      let currentTarget = null;

      function attachTooltip(element, text) {
        element.addEventListener("mouseenter", () => {
          currentTarget = element;

          tooltipTimer = setTimeout(() => {
            const rect = currentTarget.getBoundingClientRect();
            tooltip.innerText = text;
            tooltip.style.opacity = 1;
            tooltip.style.display = "block"; // make visible to measure height and width

            const tooltipHeight = tooltip.offsetHeight;
            const tooltipWidth = tooltip.offsetWidth;

            // Determine space above and below
            const spaceAbove = rect.top;
            const spaceBelow = window.innerHeight - rect.bottom;

            // Flip dynamically: above if possible, otherwise below
            if (spaceAbove > tooltipHeight + 10) {
              tooltip.style.top = rect.top + window.scrollY - tooltipHeight - 6 + "px";
            } else {
              tooltip.style.top = rect.bottom + window.scrollY + 6 + "px";
            }

            // Center horizontally over the button
            tooltip.style.left = rect.left + window.scrollX + (rect.width / 2) - (tooltipWidth / 2) + "px";
          }, 250);
        });

        element.addEventListener("mouseleave", () => {
          clearTimeout(tooltipTimer);
          tooltip.style.opacity = 0;
          currentTarget = null;
        });
      }

      const trackList = wrapper.querySelector(".at-track-list");
      api.scoreLoaded.on((score) => {
        // clear items
        trackList.innerHTML = "";
        // load all tracks to activeTracks
        activeTracks = [...score.tracks];
        // generate a track item for all tracks of the score
        score.tracks.forEach((track) => {
          const item = createTrackItem(track, score);
          trackList.appendChild(item);
          item.classList.add("active");
        });
        api.renderTracks(activeTracks);

        //load footer information
        wrapper.querySelector('.at-song-title').innerText = score.title || '';

        // update the browser tab title
        if (score.title && score.title.trim() !== '') {
          document.title = score.title + ' - AlphaTab';
        } else {
          // fallback to filename (if metadata missing)
          const filename = fileParam?.replace('.mxl', '') + ' - AlphaTab' || 'AlphaTab Score';
          document.title = filename;
        }
      });
      
      api.renderStarted.on(() => {
        // collect tracks being rendered
        const tracks = new Map();
        api.tracks.forEach((t) => {
          tracks.set(t.index, t);
        });
        // mark the item as active or not
        const trackItems = trackList.querySelectorAll(".at-track");
        trackItems.forEach((trackItem) => {
          if (tracks.has(trackItem.track.index)) {
            trackItem.classList.add("active");
          } else {
            trackItem.classList.remove("active");
          }
        });
      });

      //toggle count-in
      const countIn = wrapper.querySelector('.at-controls .at-count-in');
      attachTooltip(countIn, "Count In");
      countIn.onclick = () => {
        countIn.classList.toggle('active');
        if (countIn.classList.contains('active')) {
          api.countInVolume = 1;
        } else {
          api.countInVolume = 0;
        }
      };

      //toggle metronome
      const metronome = wrapper.querySelector('.at-controls .at-metronome');
      attachTooltip(metronome, "Metronome");
      metronome.onclick = () => {
        metronome.classList.toggle('active');
        if (metronome.classList.contains('active')) {
          api.metronomeVolume = 1;
        } else {
          api.metronomeVolume = 0;
        }
      };

      //toggle looping
      const loop = wrapper.querySelector('.at-controls .at-loop');
      attachTooltip(loop, "Loop");
      loop.onclick = () => {
        loop.classList.toggle('active');
        api.isLooping = loop.classList.contains('active');
      };

      //print
      const printBtn = wrapper.querySelector('.at-controls .at-print');
      attachTooltip(printBtn, "Print Score");
      printBtn.onclick = () => {
        /**const printWindow = window.open(printURL, '_blank');
        printWindow.onload = () => {
          printWindow.focus();
          printWindow.print();
        };*/
        const printWindow = window.open('', 'PrintWindow', 'width=800,height=1060');
  
        printWindow.document.write(`
          <html>
            <head>
              <title>Print</title>
              <style>body, html {margin:0; padding:0; height:100%;}</style>
            </head>
            <body>
              <iframe src="${pdfIframe.src}" frameborder="0" style="width:100%;height:100%;"></iframe>
            </body>
          </html>
        `);
        
        printWindow.document.close();
        printWindow.focus();

        setTimeout(() => {
          printWindow.print();
        }, 500); // small delay for the PDF to render
      };

      //zoom
      const zoomSlct = wrapper.querySelector('.at-controls .at-zoom select');
      attachTooltip(zoomSlct, "Zoom");
      zoomSlct.onchange = ()=>{
        const zoomLevel = parseInt(zoomSlct.value) / 100;
        api.settings.display.scale = zoomLevel;
        api.updateSettings();
        api.render();
      };

      //layout selector
      const layout = wrapper.querySelector('.at-controls .at-layout select');
      attachTooltip(layout, "Layout Selector");
      layout.onchange = () => {
        switch (layout.value) {
          case 'horizontal':
            api.settings.display.layoutMode = alphaTab.LayoutMode.Horizontal;
            break;
          case 'page':
            api.settings.display.layoutMode = alphaTab.LayoutMode.Page;
            break;
        }
        api.updateSettings();
        api.render();
      };
      //loading info
      const playerIndicator = wrapper.querySelector(
        ".at-controls .at-player-progress"
      );
      api.soundFontLoad.on((e) => {
        const percentage = Math.floor((e.loaded / e.total) * 100);
        playerIndicator.innerText = percentage + "%";
      });
      api.playerReady.on(()=>{playerIndicator.style.display = 'none'});
      //play-pause buttons
      const playPause = wrapper.querySelector(".at-controls .at-player-play-pause");
      attachTooltip(playPause, "Play / Pause");
      const stop = wrapper.querySelector(".at-controls .at-player-stop");
      attachTooltip(stop, "Stop & Rewind");
      playPause.onclick = (e) => {
        if (e.target.classList.contains("disabled")) {
          return;
        }
        api.playPause();
      };
      stop.onclick = (e) => {
        if(e.target.classList.contains("disabled")){
          return;
        }
        api.stop();
      };
      api.playerReady.on(() => {
        playPause.classList.remove("disabled");
        stop.classList.remove("disabled");
      });
      api.playerStateChanged.on((e) => {
        const icon = playPause.querySelector("i.fas");
        if (e.state === alphaTab.synth.PlayerState.Playing) {
          icon.classList.remove("fa-play");
          icon.classList.add("fa-pause");
        } else {
          icon.classList.remove("fa-pause");
          icon.classList.add("fa-play");
        }
      });
      function formatDuration(milliseconds) {
        let seconds = milliseconds / 1000;
        const minutes = (seconds / 60) | 0;
        seconds = (seconds - minutes * 60) | 0;
        return (
          String(minutes).padStart(2, "0") +
          ":" +
          String(seconds).padStart(2, "0")
        );
      }

      const songPosition = wrapper.querySelector(".at-song-position");
      let previousTime = -1;
      api.playerPositionChanged.on((e) => {
        // reduce number of UI updates to second changes.
        const currentSeconds = (e.currentTime / 1000) | 0;
        if (currentSeconds == previousTime) {
          return;
        }

        songPosition.innerText =
          formatDuration(e.currentTime) + " / " + formatDuration(e.endTime);
      });

    </script>
  </body>
</html>